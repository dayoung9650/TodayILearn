# 4장. Elasticsearch 기본개념
본 장에서는 ES 기본 구성 개념을 공부한다.

## 클러스터
- 클러스터란 여러 대의 컴퓨터 혹은 구성 요소들을 논리적으로 결합하여 전체를 하나의 컴퓨터 혹은 하나의 구성요소처럼 사용할 수 있게 해주는 기술이다.
- 고유 이름과 고유 UUID (UNIVERSALLY UNIQUE LDENTIFIER) 를 가짐
- 

### 단일 노드로 클러스터를 구성하지 않는 이유
- 하나의 노드로 클러스터를 구성했을 때 해당 노드에 장애 발생하면 ES 접근 불가능 상태가 된다.
- 다수의 노드로 클러스터를 구성할 경우 하나의 노드에서 장애가 발생하더라도 다른 노드에 요청할 수 있기 때문에 안정적으로 클러스터 유지가능하다.

## 노드
- 클러스터를 구성하는 논리적인 ES 프로세스 하나
- 고유 이름과 고유 UUID (UNIVERSALLY UNIQUE LDENTIFIER) 를 가짐
- 보통 운영 환경에서는 클러스터를 구성 시 역할에 따라 노드의 개수를 결정해서 클러스터를 구성해야 함 (정족수)
- 각각의 노드는 하나의 역할만 하는 것이 아니라 다양한 역할을 할 수도 있다.

| 노드 역할 | 설명 |
| ------ | ------ |
| 마스터 | 클러스터 구성에서 중심이 되는 노드 클러스터의 상태 등 메타데이터를 관리한다. |
| 데이터 |사용자의 문서를 실제로 저장하는 노드|
| 인제스트 | 사용자의 문서가 저장되기 전 문서 내용을 사전 처리하는 노드 |
| 코디네이트 | 사용자의 요청을 데이터 노드로 전달하고 다시 데이터 노드로부터 결과를 취합하는 노드|

## 인덱스, 타입
- 인덱스 : 사용자의 데이터가 저장되는 논리적인 공간
- 타입 : 인덱스 안의 데이터를 유형 별로 논리적으로 나눠 놓은 공간, 6.x 버전 이후로 사라진 개념 (이유 참고: https://dada0-0.tistory.com/entry/기초부터-다지는-Elasticsearch-운영-노하우-14장)

## 샤드, 세그먼트
- 샤드 : 인덱스에 색인되는 문서들이 저장되는 논리적 공간 (1)
- 세그먼트 : 샤드의 데이터들을 가지고 있는 물리적인 파일 (N)

### 프라이머리 샤드, 레플리카 샤드
- ES 는 고가용성을 위해 프라이머리, 레플리카 샤드를 지정해둠. 한 노드에서 장애가 발생하였을 때 레플리카 샤드를 프라이머리로 승격시켜 사용하기 위함
- 프라이머리 샤드는 최초 인덱스를 생성할 때 개수를 결정, 변경 불가
- 인덱스에 저장되는 문서는 해시알고리즘에 의해서 샤드들에 분산 저장되고 이 문서는 실제로는 세그먼트라는 물리적 파일에 저장된다
- 레플리카 샤드는 프라이머리 샤드와 동일한 문서를 가지고 있기 때문에 사용자의 검색 요청에도 응답할 수 있다. 
- 레플리카 샤드를 늘리면 검색 요청에 대한 응답 속도를 높일 수 있다.
- default 6.x -> 5개의 프라이머리 샤드 / 7.x -> 1개의 프라이머리 샤드

### 레플리카 샤드를 사용하는 이유
- 한 노드에서 장애가 발생하여 클러스터를 이탈하게 되면 해당 노드에 있던 도큐먼트들은 검색되지 않는다.
- 이를 위해 다른 노드에 저장했던 레플리카 샤드를 활성화시켜서 검색이 가능하도록 한다.
- 레플리카 샤드는 프라이머리 샤드와 동일한 내용을 가지고 있지만 프라이머리 샤드가 저장된 노드와 다른 노드에 저장되기  때문이다.

### ES가 문서를 색인할 때 저장하는 프라이머리 샤드를 어떻게 결정할까?
- 프라이머리 샤드 번호 = HASH(문서의 id) % 프라이머리 샤드 개수
- 
### 인덱스 생성 후 프라이머리 샤드 개수를 변경할 수 없는 이유
- 문서를 저장할 때 프라이머리 샤드 번호를 결정하는데에 프라이머리 샤드 개수가 사용되기 때문
- 만약 프라이머리 샤드 개수를 변경하게 되면 문서들의 샤드 번호도 모두 바껴야 한다.

### 세그먼트의 불변성 , 세그먼트 병합
- 데이터를 업데이트하려고 시도하면 ES 는 새로운 세그먼트에 업데이트할 문서의 내용을 새롭게 쓰고 기존의 데이터는 더 이상 쓰지 못하게 불용처리한다.
- 삭제되고 업데이트 되는 데이터들이 쌓이게 되면서 세그먼트의 크기가 커지게 된다 
- 이 단점을 보완하기 위해 세그먼트 병합을 진행한다
- 백그라운드에서 여러 개의 작은 세그먼트들을 하나의 큰 세그먼트로 합치는 작업이 무수히 일어난다.
- 병합 시 불용한 데이터들은 실제로 디스크에서 삭제된다.

### ES 준실시간성 특성의 이유
- 문서가 생성되자 마자 세그먼트라는 물리적 파일에 저장되는 것은 아니다.
- 색인된 문서는 먼저 시스템의 메모리 버퍼 캐시에 저장된다. 이 경우네는 해당 문서가 검색되지 않는다.
- 이후 ES 의 refresh 라는 과정을 거쳐야 디스크에 세그먼트 단위로 문서가 저장되고 해당 문서의 검색이 가능해진다.


